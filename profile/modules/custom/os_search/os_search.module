<?php

/**
 * @file
 * Hook implementations for the os_search module.
 */

use Drupal\search_api\Query\QueryInterface;
use Drupal\os_search\Plugin\OsWidgets\SearchSortWidget;

/**
 * Implements hook_theme().
 */
function os_search_theme($existing, $type, $theme, $path) {
  return [
    'os_filter_taxonomy_widget' => [
      'variables' => [
        'header' => '',
        'items' => [],
      ],
    ],
  ];
}

/**
 * Implements hook_search_api_query_alter().
 */
function os_search_search_api_query_alter(QueryInterface &$query) {
  $group_context = \Drupal::service('vsite.context_manager');
  $group = $group_context->getActiveVsite();

  // Load grouped content if search belongs to vsite.
  if ($group) {
    $group_id = $group->id();
    $query->addCondition('custom_search_group', $group_id, '=');
  }

  // Add unreal condition to remove default search results from global search.
  if (!$group && !$query->getKeys()) {
    $query->addCondition('custom_search_group', 0, '=');
  }

  // Allow enabled Apps only.
  $app_loader = \Drupal::service('os_app_access.app_loader');
  $current_user = \Drupal::currentUser();
  $enabled_apps = $app_loader->getAppsForUser($current_user);

  $enabled_apps_list = [];

  foreach ($enabled_apps as $enabled_app) {
    if (isset($enabled_app['bundle'])) {
      $enabled_apps_list = array_merge($enabled_apps_list, $enabled_app['bundle']);
    }
    else {
      $enabled_apps_list[] = $enabled_app['entityType'];
    }
  }

  if ($enabled_apps_list) {
    $query->addCondition('custom_search_bundle', $enabled_apps_list, 'IN');
  }

  // Get the sort url parameter.
  $request = \Drupal::request();
  $sort = $request->query->get('sort');
  $sort_direction = $request->query->get('dir') ?? 'ASC';
  if ($sort) {
    $sort_type = SearchSortWidget::SORT_TYPE;
    if (in_array($sort, $sort_type)) {
      $query->sort('custom_' . $sort, $sort_direction);
    }
  }

}
